<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CarWarriors Knowledge + Live Inventory</title>
  <meta name="description" content="Single-page public hub with CarWarriors knowledge modules and live vehicle inventory, optimized for humans and AI web scraping." />
  <meta name="robots" content="index,follow" />
  <link rel="canonical" href="https://gyoan-byte.github.io/carwarriors-kb/" />
  <link rel="alternate" type="application/json" href="https://dc-leads-processor.gyoan.workers.dev/latest" title="Live Inventory JSON" />
  <link rel="alternate" type="application/json" href="https://dc-leads-processor.gyoan.workers.dev/stats" title="Live Inventory Stats JSON" />
  <link rel="alternate" type="text/csv" href="https://dc-leads-processor.gyoan.workers.dev/latest/raw" title="Live Inventory CSV" />
  <link rel="alternate" type="text/plain" href="https://gyoan-byte.github.io/carwarriors-kb/llms.txt" title="LLMs Access File" />
  <style>
    :root {
      --bg: #f4f7fa;
      --surface: #ffffff;
      --ink: #152432;
      --muted: #5f7286;
      --line: #d9e3ec;
      --brand: #0f6b9b;
      --brand-dark: #0b4f73;
      --brand-soft: #e6f4fc;
      --warn-soft: #fff5d6;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      color: var(--ink);
      font-family: "Segoe UI", "Noto Sans", "Liberation Sans", sans-serif;
      background: radial-gradient(circle at 0 0, #e8f5ff, var(--bg) 55%);
      line-height: 1.42;
    }
    .wrap { max-width: 1180px; margin: 0 auto; padding: 20px; }
    header {
      background: linear-gradient(135deg, var(--brand), #0a3f5f);
      color: #fff;
      border-radius: 14px;
      padding: 18px 20px;
      margin-bottom: 16px;
    }
    h1 { margin: 0 0 6px; font-size: 1.7rem; }
    h2 { margin: 0 0 10px; font-size: 1.1rem; color: var(--brand-dark); }
    p { margin: 0; }
    .meta { margin-top: 8px; color: #d9eef9; font-size: 0.92rem; }
    .card {
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 14px;
    }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, minmax(220px, 1fr)); gap: 10px; }
    .grid-4 { display: grid; grid-template-columns: repeat(4, minmax(140px, 1fr)); gap: 10px; }
    .stat {
      border: 1px solid #cbe7f7;
      background: var(--brand-soft);
      border-radius: 10px;
      padding: 9px 10px;
    }
    .stat small { color: var(--muted); display: block; }
    .stat strong { color: var(--brand-dark); font-size: 1.1rem; }
    .chips { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip {
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 6px 10px;
      background: #fff;
      color: var(--muted);
      text-decoration: none;
      font-size: 0.9rem;
    }
    .chip:hover { border-color: var(--brand); color: var(--brand); }
    .chip.primary { background: #0b4f73; border-color: #08374f; color: #fff; }
    .chip.primary:hover { background: #08374f; border-color: #06293a; color: #fff; }
    .list { margin: 8px 0 0 18px; padding: 0; }
    .list li { margin: 4px 0; }
    .muted { color: var(--muted); }
    .warning {
      background: var(--warn-soft);
      border: 1px solid #f2dc8d;
      color: #745f18;
      border-radius: 10px;
      padding: 10px;
      margin-top: 10px;
      display: none;
    }
    .controls {
      display: grid;
      grid-template-columns: 1.5fr 1fr 1fr 0.8fr;
      gap: 8px;
      margin-top: 10px;
    }
    .control {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.9rem;
      color: var(--muted);
    }
    .control input, .control select {
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 8px;
      font-size: 0.95rem;
      color: var(--ink);
      background: #fff;
    }
    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .button-link {
      display: inline-block;
      text-decoration: none;
      color: #fff;
      background: var(--brand);
      border: 1px solid var(--brand);
      border-radius: 8px;
      padding: 7px 10px;
      font-size: 0.9rem;
    }
    .button-link.alt { background: #fff; color: var(--brand); }
    .result-line { margin-top: 10px; color: var(--muted); font-size: 0.92rem; }
    .scroll { overflow: auto; border: 1px solid var(--line); border-radius: 10px; margin-top: 8px; }
    table { width: 100%; border-collapse: collapse; min-width: 900px; }
    th, td { padding: 9px 10px; border-bottom: 1px solid var(--line); text-align: left; }
    thead th {
      background: #f2f9fd;
      color: var(--brand-dark);
      font-size: 0.9rem;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody tr:hover { background: #fbfdff; }
    .pagination { display: flex; align-items: center; gap: 8px; margin-top: 10px; }
    .pagination button {
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      color: var(--ink);
    }
    .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }

    .brand-groups {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .brand-block {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      overflow: hidden;
    }
    .brand-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 10px 12px;
      background: #f7fbfe;
      border-bottom: 1px solid var(--line);
    }
    .brand-title {
      margin: 0;
      font-size: 1.03rem;
      color: var(--brand-dark);
    }
    .brand-count {
      font-size: 0.86rem;
      color: var(--muted);
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 3px 8px;
      background: #fff;
    }
    .brand-table-wrap { overflow: auto; }
    .brand-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 640px;
      font-size: 0.9rem;
    }
    .brand-table th,
    .brand-table td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--line);
      text-align: left;
      vertical-align: top;
      white-space: nowrap;
    }
    .brand-table th {
      background: #fbfdff;
      color: var(--muted);
      font-size: 0.78rem;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }
    .field-defs {
      margin-top: 10px;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
      background: #fafcff;
      font-size: 0.9rem;
    }
    .field-defs p { margin: 0 0 6px; color: var(--muted); }
    .field-defs ul { margin: 0; padding-left: 18px; }
    .field-defs li { margin: 3px 0; }

    code { background: #eef3f7; padding: 2px 5px; border-radius: 4px; }
    pre { background: #0b1a24; color: #eaf3fb; padding: 12px; border-radius: 10px; overflow: auto; }
    pre code { background: transparent; padding: 0; color: inherit; }

    /* README rendering */
    .readme {
      font-size: 0.98rem;
      line-height: 1.6;
    }
    .readme h1, .readme h2, .readme h3 { margin: 14px 0 8px; color: var(--brand-dark); }
    .readme p { margin: 10px 0; }
    .readme ul, .readme ol { margin: 10px 0 10px 20px; }
    .readme a { color: var(--brand); text-decoration: none; }
    .readme a:hover { text-decoration: underline; }
    .readme hr { border: 0; border-top: 1px solid var(--line); margin: 14px 0; }

    /* "Pages" via hash routing */
    [data-page] { display: none; }
    [data-page].active { display: block; }

    footer { text-align: center; color: var(--muted); font-size: 0.9rem; padding: 8px 0 20px; }

    @media (max-width: 900px) {
      .grid-2, .controls, .brand-groups, .grid-3 { grid-template-columns: 1fr; }
      .grid-4 { grid-template-columns: repeat(2, minmax(120px, 1fr)); }
      table { min-width: 760px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>CarWarriors Knowledge + Live Inventory</h1>
      <p>Single public page for knowledge modules and real inventory data, readable by people and AI crawlers.</p>

      <!-- NEW: top nav for "pages" -->
      <div class="chips" style="margin-top:10px">
        <a class="chip primary" href="#home" rel="nofollow">Home (README)</a>
        <a class="chip primary" href="#inventory" rel="nofollow">Inventory</a>
        <a class="chip primary" href="#modules" rel="nofollow">Modules</a>
      </div>

      <div class="meta">Source: Worker JSON endpoints | sorting: make asc, year desc, odometer asc</div>
    </header>

    <main>
      <!-- PAGE: HOME -->
      <section class="page" data-page="home">
        <section class="card" aria-label="Operational context">
          <h2>Operational Context</h2>
          <div class="grid-2">
            <div>
              <p class="muted">Authority hierarchy:</p>
              <ol class="list">
                <li>Safety and Compliance</li>
                <li>Financing Rules</li>
                <li>Inventory and Availability</li>
                <li>Purchase Process</li>
                <li>Trade-In</li>
              </ol>
              <p class="muted"><strong>Golden rule:</strong> Safety &gt; Financing &gt; Inventory &gt; Everything else.</p>
            </div>
            <div>
              <p class="muted">Business facts:</p>
              <ul class="list">
                <li>CarWarriors LLC</li>
                <li>3620 NW 27th Ave, Miami, FL 33142</li>
                <li>Languages: English and Spanish</li>
                <li>Time zone: America/New_York</li>
              </ul>
            </div>
          </div>
        </section>

        <!-- NEW: README visible on main view -->
        <section class="card" aria-label="README content">
          <h2>README (Rendered)</h2>
          <p class="muted">This content is loaded from <code>README.md</code> in this repository.</p>
          <div class="warning" id="readme-warning"></div>
          <div id="readme-render" class="readme">Loading README...</div>
        </section>

        <section class="card" aria-label="Live inventory links">
          <h2>Live Inventory Links</h2>
          <div class="chips">
            <a class="chip" href="https://dc-leads-processor.gyoan.workers.dev/latest" target="_blank" rel="noopener">Current inventory JSON</a>
            <a class="chip" href="https://dc-leads-processor.gyoan.workers.dev/latest/meta" target="_blank" rel="noopener">Latest inventory metadata</a>
            <a class="chip" href="https://dc-leads-processor.gyoan.workers.dev/latest/raw" target="_blank" rel="noopener">Raw CSV</a>
            <a class="chip" href="https://dc-leads-processor.gyoan.workers.dev/stats" target="_blank" rel="noopener">Stats JSON</a>
            <a class="chip" href="llms.txt" target="_blank" rel="noopener">LLMs file</a>
          </div>
        </section>

        <section class="card" aria-label="Agent access contract">
          <h2>Agent Access</h2>
          <p class="muted">Machine-readable contract for crawlers and AI agents. Use JSON endpoints as primary source.</p>
          <pre><code id="agent-contract-json">{
  "version": "2026-02-18",
  "base_url": "https://dc-leads-processor.gyoan.workers.dev",
  "endpoints": {
    "inventory_latest": "/latest",
    "inventory_stats": "/stats",
    "inventory_meta": "/latest/meta",
    "inventory_raw_csv": "/latest/raw",
    "mail_latest_meta": "/mail/latest",
    "mail_latest_text": "/mail/latest/raw"
  },
  "inventory_schema": {
    "columns": [
      "Created Date",
      "Stock Number",
      "Year",
      "Make",
      "Model",
      "Exterior Color",
      "Odometer",
      "GPS Provider"
    ],
    "default_sort": "Make asc, Year desc, Odometer asc"
  }
}</code></pre>
        </section>
      </section>

      <!-- PAGE: MODULES -->
      <section class="page" data-page="modules">
        <section class="card" aria-label="Knowledge modules">
          <h2>Public Knowledge Modules (.md)</h2>
          <div class="chips">
            <a class="chip" href="README.md" target="_blank" rel="noopener">README</a>
            <a class="chip" href="01_Identidad_Negocio.md" target="_blank" rel="noopener">01 Identity</a>
            <a class="chip" href="02_Inventario.md" target="_blank" rel="noopener">02 Inventory Policy</a>
            <a class="chip" href="03_Financiamiento.md" target="_blank" rel="noopener">03 Financing</a>
            <a class="chip" href="04_Proceso_Compra.md" target="_blank" rel="noopener">04 Purchase Process</a>
            <a class="chip" href="05_Trade_In.md" target="_blank" rel="noopener">05 Trade-In</a>
            <a class="chip" href="06_Objetiones.md" target="_blank" rel="noopener">06 Objections</a>
            <a class="chip" href="07_Seguridad.md" target="_blank" rel="noopener">07 Safety</a>
            <a class="chip" href="08_Tono_Comportamiento.md" target="_blank" rel="noopener">08 Tone</a>
            <a class="chip" href="09_Escalacion.md" target="_blank" rel="noopener">09 Escalation</a>
            <a class="chip" href="10_Limites_Bot.md" target="_blank" rel="noopener">10 Limits</a>
            <a class="chip" href="11_Transiciones.md" target="_blank" rel="noopener">11 Transitions</a>
            <a class="chip" href="12_Conversaciones_Dificiles.md" target="_blank" rel="noopener">12 Difficult Conversations</a>
            <a class="chip" href="13_Logica_Condicional.md" target="_blank" rel="noopener">13 Logic</a>
            <a class="chip" href="14_Conocimiento_Automotriz_Basico.md" target="_blank" rel="noopener">14 Automotive Basics</a>
            <a class="chip" href="15_Confianza_y_Autoridad.md" target="_blank" rel="noopener">15 Trust</a>
            <a class="chip" href="16_Psicologia_Comercial.md" target="_blank" rel="noopener">16 Commercial Psychology</a>
            <a class="chip" href="behavioral_guidelines.md" target="_blank" rel="noopener">Behavioral Guidelines</a>
            <a class="chip" href="conversation_flow_map.md" target="_blank" rel="noopener">Conversation Flow Map</a>
          </div>
        </section>
      </section>

      <!-- PAGE: INVENTORY -->
      <section class="page" data-page="inventory">
        <section class="card" aria-label="Live inventory">
          <h2>Inventory</h2>
          <p class="muted">Vehicles organized by make, sorted by make asc, year desc, odometer asc.</p>
          <div id="inventory-stats" class="grid-4">
            <div class="stat"><small>Total vehicles</small><strong>...</strong></div>
            <div class="stat"><small>Brands</small><strong>...</strong></div>
            <div class="stat"><small>Min odometer</small><strong>...</strong></div>
            <div class="stat"><small>Max odometer</small><strong>...</strong></div>
          </div>
          <div class="warning" id="inventory-warning"></div>
          <p class="result-line" id="inventory-meta">Loading inventory from API...</p>
          <div class="field-defs" aria-label="Inventory field definitions">
            <p>Field definitions (scraping contract):</p>
            <ul>
              <li><code>Year</code>: vehicle model year</li>
              <li><code>Model</code>: model name from source CSV</li>
              <li><code>Stock</code>: dealer stock number</li>
              <li><code>Odometer</code>: mileage in miles</li>
              <li><code>Color</code>: exterior color</li>
              <li><code>GPS</code>: GPS provider value if available</li>
              <li><code>Created</code>: created date from source inventory</li>
            </ul>
          </div>
          <div class="brand-groups" id="inventory-brands"></div>
        </section>
      </section>

      <noscript>
        <section class="card">
          <p>JavaScript is required for the interactive dashboard. Direct links still work:</p>
          <p><code>https://dc-leads-processor.gyoan.workers.dev/latest</code></p>
          <p><code>https://dc-leads-processor.gyoan.workers.dev/latest/raw</code></p>
        </section>
      </noscript>
    </main>

    <footer>
      Real fields only. No inferred categories. Public, crawlable, and structured for AI extraction.
    </footer>
  </div>

  <script id="knowledge-context" type="application/json">
    {
      "business_name": "CarWarriors LLC",
      "address": "3620 NW 27th Ave, Miami, FL 33142",
      "market": "Miami, Florida",
      "languages": ["English", "Spanish"],
      "timezone": "America/New_York",
      "golden_rule": "Safety > Financing > Inventory > Everything else",
      "compliance_limits": [
        "No exact prices",
        "No monthly payment estimates",
        "No APR numbers or rate quotes",
        "No guaranteed approvals or inventory promises"
      ]
    }
  </script>

  <script id="inventory-agent-json" type="application/json">{}</script>

  <script id="inventory-jsonld" type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Dataset",
      "name": "CarWarriors Live Inventory",
      "description": "Live inventory feed from Cloudflare Worker endpoints.",
      "url": "https://gyoan-byte.github.io/carwarriors-kb/",
      "distribution": [
        {
          "@type": "DataDownload",
          "encodingFormat": "application/json",
          "contentUrl": "https://dc-leads-processor.gyoan.workers.dev/latest"
        },
        {
          "@type": "DataDownload",
          "encodingFormat": "text/csv",
          "contentUrl": "https://dc-leads-processor.gyoan.workers.dev/latest/raw"
        }
      ]
    }
  </script>

  <script type="module">
    const API_BASE = "https://dc-leads-processor.gyoan.workers.dev";
    const ui = {
      pages: Array.from(document.querySelectorAll("[data-page]")),
      readmeRender: document.getElementById("readme-render"),
      readmeWarning: document.getElementById("readme-warning"),
      inventoryStats: document.getElementById("inventory-stats"),
      inventoryWarning: document.getElementById("inventory-warning"),
      inventoryMeta: document.getElementById("inventory-meta"),
      inventoryBrands: document.getElementById("inventory-brands"),
      inventoryAgentJson: document.getElementById("inventory-agent-json")
    };

    function route() {
      const hash = (globalThis.location.hash || "#home").replaceAll("#", "").trim().toLowerCase();
      const page = (hash === "inventory" || hash === "modules" || hash === "home") ? hash : "home";
      for (const el of ui.pages) {
        el.classList.toggle("active", el.dataset.page === page);
      }
    }

    async function loadReadmeIntoHome() {
      try {
        const res = await fetch("README.md", { cache: "no-store" });
        if (!res.ok) throw new Error("README.md not found");
        const md = await res.text();
        ui.readmeWarning.style.display = "none";
        ui.readmeRender.innerHTML = renderMarkdownLite(md);
      } catch (e) {
        console.error("loadReadmeIntoHome error:", e);
        ui.readmeWarning.style.display = "block";
        ui.readmeWarning.textContent = "Could not load README.md for the home view.";
        ui.readmeRender.textContent = "README unavailable.";
      }
    }

    route();
    globalThis.addEventListener("hashchange", route);
    loadReadmeIntoHome();
    loadInventoryIntoPage();

    async function loadInventoryIntoPage() {
      try {
        const [latestRes, statsRes] = await Promise.all([
          fetch(`${API_BASE}/latest`, { cache: "no-store" }),
          fetch(`${API_BASE}/stats`, { cache: "no-store" })
        ]);
        if (!latestRes.ok) throw new Error(`latest returned ${latestRes.status}`);

        const latest = await latestRes.json();
        const stats = statsRes.ok ? await statsRes.json() : null;
        const rows = Array.isArray(latest?.rows) ? latest.rows : [];
        if (!rows.length) throw new Error("No rows in latest payload.");

        ui.inventoryWarning.style.display = "none";
        ui.inventoryMeta.textContent = buildInventoryMetaText(latest, rows.length);
        ui.inventoryStats.innerHTML = buildInventoryStatsHtml(rows, stats);
        ui.inventoryBrands.innerHTML = renderInventoryByMake(rows);
        ui.inventoryAgentJson.textContent = JSON.stringify(buildAgentInventoryPayload(latest, rows), null, 2);
      } catch (error) {
        console.error("loadInventoryIntoPage error:", error);
        ui.inventoryWarning.style.display = "block";
        ui.inventoryWarning.textContent = "Could not load live inventory data from API.";
        ui.inventoryMeta.textContent = "Inventory unavailable right now.";
        ui.inventoryStats.innerHTML = "";
        ui.inventoryBrands.innerHTML = "";
        ui.inventoryAgentJson.textContent = "{}";
      }
    }

    function buildInventoryMetaText(latest, rowCount) {
      const receivedAt = latest?.latest?.receivedAt ? new Date(latest.latest.receivedAt) : null;
      const receivedText = receivedAt && !Number.isNaN(receivedAt.getTime())
        ? receivedAt.toLocaleString("en-US")
        : "unknown";
      const fileName = String(latest?.latest?.filename || "unknown");
      return `Last update: ${receivedText} | File: ${fileName} | Vehicles: ${rowCount}`;
    }

    function buildInventoryStatsHtml(rows, stats) {
      const brands = new Set(rows.map((row) => String(row["Make"] || "").trim()).filter(Boolean));
      const odometers = rows
        .map((row) => Number.parseInt(String(row["Odometer"] || "").replaceAll(",", ""), 10))
        .filter((value) => Number.isFinite(value));

      const minOdometer = stats?.odometer?.min ?? (odometers.length ? Math.min(...odometers) : null);
      const maxOdometer = stats?.odometer?.max ?? (odometers.length ? Math.max(...odometers) : null);

      return [
        statCard("Total vehicles", String(rows.length)),
        statCard("Brands", String(brands.size)),
        statCard("Min odometer", formatMiles(minOdometer)),
        statCard("Max odometer", formatMiles(maxOdometer))
      ].join("");
    }

    function statCard(label, value) {
      return `<div class="stat"><small>${escapeHtml(label)}</small><strong>${escapeHtml(value)}</strong></div>`;
    }

    function renderInventoryByMake(rows) {
      const groups = new Map();
      for (const row of rows) {
        const make = String(row["Make"] || "").trim() || "UNKNOWN";
        if (!groups.has(make)) groups.set(make, []);
        groups.get(make).push(row);
      }

      const out = [];
      const sortedMakes = Array.from(groups.keys()).sort((a, b) => a.localeCompare(b, "en", { sensitivity: "base" }));
      for (const make of sortedMakes) {
        const vehicles = [...groups.get(make)].sort(compareVehicles);
        out.push(`<section class="brand-block" data-make="${escapeAttr(make)}">`);
        out.push('<div class="brand-head">');
        out.push(`<h3 class="brand-title">${escapeHtml(make)}</h3>`);
        out.push(`<span class="brand-count">${vehicles.length} units</span>`);
        out.push("</div>");
        out.push('<div class="brand-table-wrap"><table class="brand-table"><thead><tr><th>Year</th><th>Model</th><th>Stock</th><th>Odometer</th><th>Color</th><th>GPS</th><th>Created</th></tr></thead><tbody>');
        for (const row of vehicles) {
          const year = fieldOrNA(row, "Year");
          const model = fieldOrNA(row, "Model");
          const stock = fieldOrNA(row, "Stock Number");
          const odoRaw = fieldOrNA(row, "Odometer");
          const odo = formatMiles(odoRaw);
          const color = fieldOrNA(row, "Exterior Color");
          const gps = fieldOrNA(row, "GPS Provider");
          const created = fieldOrNA(row, "Created Date");
          out.push(
            `<tr data-make="${escapeAttr(make)}" data-year="${escapeAttr(year)}" data-model="${escapeAttr(model)}" data-stock="${escapeAttr(stock)}" data-odometer="${escapeAttr(odoRaw)}">` +
              `<td>${escapeHtml(year)}</td><td>${escapeHtml(model)}</td><td>${escapeHtml(stock)}</td><td>${escapeHtml(odo)}</td><td>${escapeHtml(color)}</td><td>${escapeHtml(gps)}</td><td>${escapeHtml(created)}</td>` +
            "</tr>"
          );
        }
        out.push("</tbody></table></div></section>");
      }
      return out.join("");
    }

    function buildAgentInventoryPayload(latest, rows) {
      const grouped = {};
      for (const row of rows) {
        const make = fieldOrNA(row, "Make");
        if (!grouped[make]) grouped[make] = [];
        grouped[make].push({
          year: fieldOrNA(row, "Year"),
          model: fieldOrNA(row, "Model"),
          stock_number: fieldOrNA(row, "Stock Number"),
          odometer: fieldOrNA(row, "Odometer"),
          exterior_color: fieldOrNA(row, "Exterior Color"),
          gps_provider: fieldOrNA(row, "GPS Provider"),
          created_date: fieldOrNA(row, "Created Date")
        });
      }
      for (const make of Object.keys(grouped)) {
        grouped[make].sort(compareVehiclesPlain);
      }

      return {
        generated_at: new Date().toISOString(),
        source_received_at: latest?.latest?.receivedAt || null,
        source_file: latest?.latest?.filename || null,
        total_vehicles: rows.length,
        fields: ["year", "model", "stock_number", "odometer", "exterior_color", "gps_provider", "created_date"],
        by_make: grouped
      };
    }

    function compareVehicles(a, b) {
      const yearDiff = parseIntOrZero(b["Year"]) - parseIntOrZero(a["Year"]);
      if (yearDiff !== 0) return yearDiff;
      const odoDiff = parseIntOrZero(a["Odometer"]) - parseIntOrZero(b["Odometer"]);
      if (odoDiff !== 0) return odoDiff;
      return fieldOrNA(a, "Stock Number").localeCompare(fieldOrNA(b, "Stock Number"), "en", { sensitivity: "base" });
    }

    function compareVehiclesPlain(a, b) {
      const yearDiff = parseIntOrZero(b.year) - parseIntOrZero(a.year);
      if (yearDiff !== 0) return yearDiff;
      const odoDiff = parseIntOrZero(a.odometer) - parseIntOrZero(b.odometer);
      if (odoDiff !== 0) return odoDiff;
      return String(a.stock_number).localeCompare(String(b.stock_number), "en", { sensitivity: "base" });
    }

    function fieldOrNA(row, key) {
      const value = String(row?.[key] ?? "").trim();
      return value || "N/A";
    }

    function parseIntOrZero(value) {
      const parsed = Number.parseInt(String(value ?? "").replaceAll(",", ""), 10);
      return Number.isFinite(parsed) ? parsed : 0;
    }

    function formatMiles(value) {
      const parsed = Number.parseInt(String(value ?? "").replaceAll(",", ""), 10);
      if (!Number.isFinite(parsed)) return "N/A";
      return `${new Intl.NumberFormat("en-US").format(parsed)} mi`;
    }

    // Lightweight markdown renderer (escaped output)
    function renderMarkdownLite(md) {
      const normalized = String(md || "").replaceAll("\r\n", "\n").trim();
      if (!normalized) return "<p>(empty)</p>";

      const blocks = normalized.split(/\n{2,}/);
      return blocks.map(renderMarkdownBlock).join("");
    }

    function renderMarkdownBlock(block) {
      const trimmed = block.trim();
      if (!trimmed) return "";

      if (trimmed.startsWith("```") && trimmed.endsWith("```")) {
        const code = trimmed.slice(3, -3).trim();
        return `<pre><code>${escapeHtml(code)}</code></pre>`;
      }

      if (/^\s*---\s*$/.test(trimmed)) return "<hr />";

      const heading = /^(#{1,3})\s+(.*)$/.exec(trimmed);
      if (heading) {
        const level = heading[1].length;
        return `<h${level}>${inlineMd(heading[2])}</h${level}>`;
      }

      const lines = trimmed.split("\n").map((line) => line.trim()).filter(Boolean);
      if (lines.every((line) => /^\d+\.\s+/.test(line))) {
        const items = buildMarkdownListItems(lines, /^\d+\.\s+/g);
        return `<ol>${items}</ol>`;
      }

      if (lines.every((line) => /^[-*]\s+/.test(line))) {
        const items = buildMarkdownListItems(lines, /^[-*]\s+/g);
        return `<ul>${items}</ul>`;
      }

      return `<p>${inlineMd(lines.join(" "))}</p>`;
    }

    function buildMarkdownListItems(lines, prefixRegex) {
      const parts = [];
      for (const line of lines) {
        const cleaned = line.replaceAll(prefixRegex, "");
        parts.push("<li>" + inlineMd(cleaned) + "</li>");
      }
      return parts.join("");
    }

    function inlineMd(text) {
      // escape first
      let s = escapeHtml(text);

      // inline code `x`
      s = s.replaceAll(/`([^`]+)`/g, (_, a) => `<code>${escapeHtml(a)}</code>`);

      // links [text](url)
      s = s.replaceAll(/\[([^\]]+)\]\(([^)]+)\)/g, (_, label, url) => {
        const safeUrl = escapeAttr(url);
        const safeLabel = escapeHtml(label);
        const isExternal = /^https?:\/\//i.test(url);
        const rel = isExternal ? ` rel="noopener"` : "";
        const target = isExternal ? ` target="_blank"` : "";
        return `<a href="${safeUrl}"${target}${rel}>${safeLabel}</a>`;
      });

      // bold **x**
      s = s.replaceAll(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");

      // italic *x*
      s = s.replaceAll(/\*([^*]+)\*/g, "<em>$1</em>");

      return s;
    }

    function escapeHtml(v) {
      return String(v)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    function escapeAttr(v) {
      return String(v).replaceAll('"', "&quot;");
    }
  </script>
</body>
</html>
