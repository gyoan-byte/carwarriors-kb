<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Base Operativa CarWarriors: Conocimiento + Inventario</title>
  <meta name="description" content="Base operativa scrapeable con contexto real de la base de conocimiento CarWarriors y el inventario de vehiculos ordenado por marca." />
  <meta name="robots" content="index,follow" />
  <link rel="canonical" href="https://gyoan-byte.github.io/carwarriors-kb/" />
  <style>
    :root {
      --bg: #f4f6f8;
      --surface: #ffffff;
      --ink: #13212f;
      --muted: #5b6b7c;
      --line: #d8e0e7;
      --brand: #0f6a9c;
      --brand-soft: #d8effa;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", "Noto Sans", "Liberation Sans", sans-serif;
      color: var(--ink);
      background: radial-gradient(circle at 0 0, #e8f6ff, var(--bg) 55%);
      line-height: 1.4;
    }
    .wrap { max-width: 1120px; margin: 0 auto; padding: 20px; }
    header {
      background: linear-gradient(135deg, #0f6a9c, #0a3f5f);
      color: #fff;
      border-radius: 12px;
      padding: 18px 20px;
      margin-bottom: 16px;
    }
    h1 { margin: 0 0 6px; font-size: 1.6rem; }
    h2 { margin: 0 0 8px; font-size: 1.15rem; }
    p { margin: 0; }
    .meta { margin-top: 8px; color: #d9eef9; font-size: 0.92rem; }
    .card {
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 14px;
    }
    .grid-two {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    .list { margin: 8px 0 0 18px; padding: 0; }
    .list li { margin: 4px 0; }
    .chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    .chip {
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 0.9rem;
      color: var(--muted);
      text-decoration: none;
    }
    .chip:hover { border-color: var(--brand); color: var(--brand); }
    .stats { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 8px; }
    .stat {
      background: var(--brand-soft);
      border: 1px solid #c1e6fa;
      border-radius: 10px;
      padding: 8px 10px;
      min-width: 160px;
    }
    .stat strong { display: block; font-size: 1.1rem; color: #0b4f75; }
    .muted { color: var(--muted); }
    .scroll { overflow: auto; border: 1px solid var(--line); border-radius: 10px; }
    table { width: 100%; border-collapse: collapse; min-width: 860px; }
    th, td { padding: 10px; border-bottom: 1px solid var(--line); text-align: left; }
    thead th {
      background: #f3f9fd;
      color: #0b4f75;
      font-size: 0.9rem;
      letter-spacing: 0.01em;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody tr:hover { background: #fbfdff; }
    code { background: #eef3f7; padding: 2px 5px; border-radius: 4px; }
    footer { text-align: center; color: var(--muted); font-size: 0.9rem; padding: 8px 0 20px; }
    @media (max-width: 760px) {
      h1 { font-size: 1.3rem; }
      .stat { min-width: 130px; }
      .grid-two { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Base Operativa CarWarriors</h1>
      <p>Contexto real de conocimiento + inventario estructurado para lectura humana y scraping por agentes AI.</p>
      <div class="meta" id="source-meta">Fuente: cargando...</div>
    </header>

    <main>
      <section class="card" aria-label="Contexto operativo real">
        <h2>Contexto Operativo Real</h2>
        <div class="grid-two">
          <div>
            <p class="muted">Autoridad y prioridad (README):</p>
            <ol class="list">
              <li>Safety and Compliance</li>
              <li>Financing Rules</li>
              <li>Inventory and Availability</li>
              <li>Purchase Process</li>
              <li>Trade-In</li>
            </ol>
            <p class="muted"><strong>Golden rule:</strong> Safety &gt; Financing &gt; Inventory &gt; Everything else.</p>
          </div>
          <div>
            <p class="muted">Identidad de negocio (01_Identidad_Negocio.md):</p>
            <ul class="list">
              <li>CarWarriors LLC (used car dealership)</li>
              <li>3620 NW 27th Ave, Miami, FL 33142</li>
              <li>Idiomas: English / Spanish</li>
              <li>Zona horaria: America/New_York</li>
            </ul>
          </div>
        </div>
        <p class="muted" style="margin-top:10px;">Cumplimiento: no precios exactos, no APR, no cuota mensual, no promesas de aprobacion o stock garantizado.</p>
      </section>

      <section class="card" aria-label="Modulos fuente de conocimiento">
        <p class="muted">Modulos fuente (.md) publicos para abrir directo con clic:</p>
        <div class="chips">
          <a class="chip" href="README.md" target="_blank" rel="noopener">README</a>
          <a class="chip" href="01_Identidad_Negocio.md" target="_blank" rel="noopener">01 Identidad</a>
          <a class="chip" href="02_Inventario.md" target="_blank" rel="noopener">02 Inventario</a>
          <a class="chip" href="03_Financiamiento.md" target="_blank" rel="noopener">03 Financiamiento</a>
          <a class="chip" href="04_Proceso_Compra.md" target="_blank" rel="noopener">04 Proceso</a>
          <a class="chip" href="05_Trade_In.md" target="_blank" rel="noopener">05 Trade-In</a>
          <a class="chip" href="06_Objetiones.md" target="_blank" rel="noopener">06 Objetiones</a>
          <a class="chip" href="07_Seguridad.md" target="_blank" rel="noopener">07 Seguridad</a>
          <a class="chip" href="08_Tono_Comportamiento.md" target="_blank" rel="noopener">08 Tono</a>
          <a class="chip" href="09_Escalacion.md" target="_blank" rel="noopener">09 Escalacion</a>
          <a class="chip" href="10_Limites_Bot.md" target="_blank" rel="noopener">10 Limites</a>
          <a class="chip" href="11_Transiciones.md" target="_blank" rel="noopener">11 Transiciones</a>
          <a class="chip" href="12_Conversaciones_Dificiles.md" target="_blank" rel="noopener">12 Conversaciones</a>
          <a class="chip" href="13_Logica_Condicional.md" target="_blank" rel="noopener">13 Logica</a>
          <a class="chip" href="14_Conocimiento_Automotriz_Basico.md" target="_blank" rel="noopener">14 Conocimiento Auto</a>
          <a class="chip" href="15_Confianza_y_Autoridad.md" target="_blank" rel="noopener">15 Confianza</a>
          <a class="chip" href="16_Psicologia_Comercial.md" target="_blank" rel="noopener">16 Psicologia</a>
          <a class="chip" href="behavioral_guidelines.md" target="_blank" rel="noopener">Behavioral Guidelines</a>
          <a class="chip" href="conversation_flow_map.md" target="_blank" rel="noopener">Conversation Flow Map</a>
        </div>
      </section>

      <section class="card" aria-label="Fuentes de inventario">
        <p class="muted">Inventario actual (enlaces directos):</p>
        <div class="chips">
          <a class="chip" href="https://dc-leads-processor.gyoan.workers.dev/latest" target="_blank" rel="noopener">Inventario actual JSON</a>
          <a class="chip" href="https://dc-leads-processor.gyoan.workers.dev/latest?sort=Make:asc,Year:desc,Odometer:asc" target="_blank" rel="noopener">JSON ordenado por marca</a>
          <a class="chip" href="https://dc-leads-processor.gyoan.workers.dev/latest/meta" target="_blank" rel="noopener">Metadata ultimo inventario</a>
          <a class="chip" href="https://dc-leads-processor.gyoan.workers.dev/latest/raw" target="_blank" rel="noopener">CSV crudo</a>
          <a class="chip" href="?make=HONDA">Filtro ejemplo make=HONDA</a>
          <a class="chip" href="?make=FORD&year=2024">Filtro ejemplo make=FORD&amp;year=2024</a>
          <a class="chip" href="?model=MODEL%203">Filtro ejemplo model=MODEL 3</a>
        </div>
      </section>

      <section class="card" aria-label="Resumen de inventario">
        <div class="stats">
          <div class="stat"><span class="muted">Vehiculos visibles</span><strong id="total-count">0</strong></div>
          <div class="stat"><span class="muted">Marcas visibles</span><strong id="brand-count">0</strong></div>
          <div class="stat"><span class="muted">Ultima actualizacion</span><strong id="updated-at">-</strong></div>
        </div>
        <p class="muted" id="active-filters">Filtros activos: ninguno</p>
        <p class="muted" id="brand-summary">Marcas: -</p>
      </section>

      <section class="card" aria-label="Tabla de inventario">
        <div class="scroll">
          <table id="inventory-table">
            <thead>
              <tr>
                <th>Stock Number</th>
                <th>Year</th>
                <th>Make</th>
                <th>Model</th>
                <th>Exterior Color</th>
                <th>Odometer</th>
                <th>GPS Provider</th>
                <th>Created Date</th>
              </tr>
            </thead>
            <tbody id="inventory-body"></tbody>
          </table>
        </div>
      </section>

      <noscript>
        <section class="card">
          <p>Activa JavaScript para ver la tabla renderizada. Mientras tanto usa:</p>
          <p><code>https://dc-leads-processor.gyoan.workers.dev/latest?sort=Make:asc,Year:desc,Odometer:asc</code></p>
        </section>
      </noscript>
    </main>

    <footer>
      Datos sin categorias inferidas. Solo campos reales del inventario y reglas reales de conocimiento.
    </footer>
  </div>

  <script id="knowledge-context" type="application/json">
    {
      "business_name": "CarWarriors LLC",
      "address": "3620 NW 27th Ave, Miami, FL 33142",
      "market": "Miami, Florida",
      "languages": ["English", "Spanish"],
      "timezone": "America/New_York",
      "authority_hierarchy": [
        "Safety and Compliance",
        "Financing Rules",
        "Inventory and Availability",
        "Purchase Process",
        "Trade-In"
      ],
      "golden_rule": "Safety > Financing > Inventory > Everything else",
      "compliance_limits": [
        "No exact prices",
        "No monthly payment estimates",
        "No APR numbers or rate quotes",
        "No guaranteed approvals or inventory promises"
      ]
    }
  </script>

  <script type="module">
    const WORKER_JSON_URL = "https://dc-leads-processor.gyoan.workers.dev/latest?sort=Make:asc,Year:desc,Odometer:asc";
    const LOCAL_CSV_URL = "carros_listos/CARROS%20LISTOS.csv";
    const URL_PARAMS = new URLSearchParams(globalThis.location.search);
    const FILTERS = {
      make: (URL_PARAMS.get("make") || "").trim().toUpperCase(),
      year: (URL_PARAMS.get("year") || "").trim(),
      model: (URL_PARAMS.get("model") || "").trim().toUpperCase()
    };

    await start();

    async function start() {
      try {
        const result = await loadFromWorker();
        render(result.rows, result.updatedAt, "Worker JSON");
      } catch {
        const rows = await loadFromLocalCsv();
        render(rows, new Date().toISOString(), "CSV local de respaldo");
      }
    }

    async function loadFromWorker() {
      const res = await fetch(WORKER_JSON_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("Worker not available");
      const payload = await res.json();
      const rows = Array.isArray(payload.rows) ? payload.rows : [];
      const updatedAt = payload?.latest?.receivedAt || new Date().toISOString();
      return { rows, updatedAt };
    }

    async function loadFromLocalCsv() {
      const res = await fetch(LOCAL_CSV_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("CSV not available");
      const text = await res.text();
      const parsed = parseCsv(text);
      return parsed.rows.map((r) => ({
        "Stock Number": r["Stock Number"] || "",
        Year: r.Year || "",
        Make: r.Make || "",
        Model: r.Model || "",
        "Exterior Color": r["Exterior Color"] || "",
        Odometer: r.Odometer || "",
        "GPS Provider": r["GPS Provider"] || "",
        "Created Date": r["Created Date"] || ""
      }));
    }

    function render(inputRows, isoDate, sourceLabel) {
      const filteredRows = applyFilters(inputRows);
      const rows = [...filteredRows].sort(compareByMakeYearMileage);
      const tbody = document.getElementById("inventory-body");
      tbody.innerHTML = rows.map(rowToHtml).join("");

      const byBrand = countBy(rows, (r) => (r.Make || "").trim());
      const brandPairs = Object.entries(byBrand).sort((a, b) => a[0].localeCompare(b[0], "es", { sensitivity: "base" }));

      document.getElementById("total-count").textContent = String(rows.length);
      document.getElementById("brand-count").textContent = String(brandPairs.length);
      document.getElementById("updated-at").textContent = formatIsoDate(isoDate);
      document.getElementById("active-filters").textContent = "Filtros activos: " + describeFilters();
      document.getElementById("source-meta").textContent = `Fuente: ${sourceLabel} | orden: Make asc, Year desc, Odometer asc`;
      document.getElementById("brand-summary").textContent =
        "Marcas: " + (brandPairs.length ? brandPairs.map(([make, n]) => `${make || "(vacio)"} (${n})`).join(" | ") : "sin datos");
    }

    function applyFilters(rows) {
      return rows.filter((r) => {
        if (FILTERS.make && String(r.Make || "").toUpperCase() !== FILTERS.make) return false;
        if (FILTERS.year && String(r.Year || "").trim() !== FILTERS.year) return false;
        if (FILTERS.model && !String(r.Model || "").toUpperCase().includes(FILTERS.model)) return false;
        return true;
      });
    }

    function describeFilters() {
      const parts = [];
      if (FILTERS.make) parts.push(`make=${FILTERS.make}`);
      if (FILTERS.year) parts.push(`year=${FILTERS.year}`);
      if (FILTERS.model) parts.push(`model~${FILTERS.model}`);
      return parts.length ? parts.join(" | ") : "ninguno";
    }

    function rowToHtml(r) {
      return `<tr>
        <td>${escapeHtml(r["Stock Number"] || "")}</td>
        <td>${escapeHtml(r.Year || "")}</td>
        <td>${escapeHtml(r.Make || "")}</td>
        <td>${escapeHtml(r.Model || "")}</td>
        <td>${escapeHtml(r["Exterior Color"] || "")}</td>
        <td>${escapeHtml(r.Odometer || "")}</td>
        <td>${escapeHtml(r["GPS Provider"] || "")}</td>
        <td>${escapeHtml(r["Created Date"] || "")}</td>
      </tr>`;
    }

    function compareByMakeYearMileage(a, b) {
      const makeCmp = String(a.Make || "").localeCompare(String(b.Make || ""), "es", { sensitivity: "base" });
      if (makeCmp !== 0) return makeCmp;

      const yearA = toNum(a.Year);
      const yearB = toNum(b.Year);
      if (yearA !== yearB) return yearB - yearA;

      const odoA = toNum(a.Odometer);
      const odoB = toNum(b.Odometer);
      return odoA - odoB;
    }

    function toNum(v) {
      const n = Number(String(v || "").replaceAll(",", "").trim());
      return Number.isFinite(n) ? n : 0;
    }

    function countBy(arr, keyFn) {
      const out = {};
      for (const item of arr) {
        const k = keyFn(item);
        out[k] = (out[k] || 0) + 1;
      }
      return out;
    }

    function formatIsoDate(v) {
      const d = new Date(v);
      if (Number.isNaN(d.getTime())) return "-";
      return d.toISOString();
    }

    function escapeHtml(v) {
      return String(v)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    function parseCsv(text) {
      const lines = text.replaceAll("\r", "").split("\n").filter((line) => line.trim() !== "");
      if (!lines.length) return { headers: [], rows: [] };

      const headers = parseCsvLine(lines[0]).map((h) => h.trim());
      const rows = [];
      for (let i = 1; i < lines.length; i++) {
        const cols = parseCsvLine(lines[i]);
        const row = {};
        for (let j = 0; j < headers.length; j++) {
          row[headers[j]] = (cols[j] || "").trim();
        }
        rows.push(row);
      }
      return { headers, rows };
    }

    function parseCsvLine(line) {
      const out = [];
      let cur = "";
      let inQuotes = false;
      let i = 0;
      while (i < line.length) {
        const c = line[i];
        if (c === '"') {
          if (inQuotes && line[i + 1] === '"') {
            cur += '"';
            i += 2;
            continue;
          }
          inQuotes = !inQuotes;
          i++;
          continue;
        }
        if (c === "," && !inQuotes) {
          out.push(cur);
          cur = "";
          i++;
          continue;
        }
        cur += c;
        i++;
      }
      out.push(cur);
      return out;
    }
  </script>
</body>
</html>
